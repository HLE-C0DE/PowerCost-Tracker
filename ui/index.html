<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerCost Tracker</title>
    <link rel="stylesheet" href="src/styles/main.css">
</head>
<body>
    <div id="app">
        <!-- Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <button class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                <span class="logo-text">PowerCost</span>
            </div>
            <ul class="nav-links">
                <li><a href="#dashboard" class="nav-link active" data-view="dashboard">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="9"/>
                        <rect x="14" y="3" width="7" height="5"/>
                        <rect x="14" y="12" width="7" height="9"/>
                        <rect x="3" y="16" width="7" height="5"/>
                    </svg>
                    <span data-i18n="nav.dashboard">Dashboard</span>
                </a></li>
                <li><a href="#history" class="nav-link" data-view="history">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                    </svg>
                    <span data-i18n="nav.history">History</span>
                </a></li>
                <li><a href="#settings" class="nav-link" data-view="settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" y1="21" x2="4" y2="14"/>
                        <line x1="4" y1="10" x2="4" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12" y2="3"/>
                        <line x1="20" y1="21" x2="20" y2="16"/>
                        <line x1="20" y1="12" x2="20" y2="3"/>
                        <line x1="1" y1="14" x2="7" y2="14"/>
                        <line x1="9" y1="8" x2="15" y2="8"/>
                        <line x1="17" y1="16" x2="23" y2="16"/>
                    </svg>
                    <span data-i18n="nav.settings">Settings</span>
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="content">
            <!-- Dashboard View -->
            <section id="dashboard" class="view active">
                <header class="view-header">
                    <h1 data-i18n="nav.dashboard">Dashboard</h1>
                    <div class="header-controls">
                        <!-- Stream A: Global Display Toggle -->
                        <div class="global-display-toggle" id="global-display-toggle" data-i18n-title="dashboard.display_mode_title">
                            <button class="global-display-btn active" data-mode="normal" data-i18n="dashboard.mode.normal">Normal</button>
                            <button class="global-display-btn" data-mode="minimize" data-i18n="dashboard.mode.minimal">Minimal</button>
                            <button class="global-display-btn" data-mode="hard" data-i18n="dashboard.mode.data">Data</button>
                        </div>
                        <div class="status-badge" id="source-badge">
                            <span class="status-dot"></span>
                            <span id="power-source">--</span>
                        </div>
                        <button class="btn btn-icon" id="edit-dashboard-btn" data-i18n-title="dashboard.edit_title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </button>
                    </div>
                </header>

                <!-- Edit Mode Toolbar -->
                <div class="edit-toolbar hidden" id="edit-toolbar">
                    <span class="edit-mode-indicator">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                        </svg>
                        <span data-i18n="dashboard.edit_mode">Edit Mode</span>
                    </span>
                    <div class="edit-toolbar-actions">
                        <button class="btn btn-secondary btn-sm" id="fix-layout-btn" title="Reset widgets to default positions">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                            </svg>
                            <span data-i18n="dashboard.default_layout">Default Layout</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" id="toggle-visibility-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <span data-i18n="dashboard.toggle_widgets">Toggle Widgets</span>
                        </button>
                        <button class="btn btn-primary btn-sm" id="exit-edit-mode-btn" data-i18n="dashboard.done">Done</button>
                    </div>
                </div>

                <!-- Visibility Panel -->
                <div class="visibility-panel hidden" id="visibility-panel">
                    <div class="visibility-panel-header">
                        <h3 data-i18n="dashboard.toggle_visibility">Toggle Widget Visibility</h3>
                        <button class="btn btn-icon btn-sm" id="close-visibility-panel">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="visibility-list" id="visibility-list">
                        <!-- Widget visibility toggles will be rendered here -->
                    </div>
                </div>

                <!-- Dashboard Grid Container -->
                <div class="dashboard-grid" id="dashboard-grid">
                    <!-- Widgets will be dynamically rendered here -->
                </div>

                <!-- Session Control Bar (Legacy - hidden, use Session Controls widget instead) -->
                <div class="session-bar hidden" id="session-bar">
                    <div class="session-info">
                        <span class="session-label" id="session-label" data-i18n="session.no_active">No active session</span>
                        <span class="session-duration" id="session-duration-display">--:--:--</span>
                    </div>
                    <div class="session-controls">
                        <button class="btn btn-primary" id="start-session-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                            <span data-i18n="session.start">Start Session</span>
                        </button>
                        <button class="btn btn-secondary hidden" id="end-session-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <rect x="6" y="4" width="4" height="16"/>
                                <rect x="14" y="4" width="4" height="16"/>
                            </svg>
                            <span data-i18n="session.end">End Session</span>
                        </button>
                    </div>
                </div>

                <!-- Estimation Warning -->
                <div id="estimation-warning" class="warning-banner hidden">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/>
                        <line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <span data-i18n="warning.estimated_values">Values are estimated and may not be accurate</span>
                </div>
            </section>

            <!-- History View -->
            <section id="history" class="view">
                <header class="view-header">
                    <h1 data-i18n="nav.history">History</h1>
                    <div class="view-tabs">
                        <button class="tab-btn active" data-tab="power-history" data-i18n="history.tab.power">Power</button>
                        <button class="tab-btn" data-tab="session-history" data-i18n="history.tab.sessions">Sessions</button>
                    </div>
                </header>

                <!-- Power History Tab -->
                <div class="tab-content active" id="power-history">
                    <div class="date-range-picker">
                        <button class="range-btn active" data-range="today" data-i18n="history.today">Today</button>
                        <button class="range-btn" data-range="week" data-i18n="history.this_week">This Week</button>
                        <button class="range-btn" data-range="month" data-i18n="history.this_month">This Month</button>
                    </div>

                    <div class="history-stats">
                        <div class="stat-card">
                            <span class="stat-label" data-i18n="history.total_consumption">Total Consumption</span>
                            <span class="stat-value" id="history-total-wh">-- kWh</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label" data-i18n="history.total_cost">Total Cost</span>
                            <span class="stat-value" id="history-total-cost">--</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label" data-i18n="history.average_power">Average Power</span>
                            <span class="stat-value" id="history-avg-power">-- W</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-label" data-i18n="history.peak_power">Peak Power</span>
                            <span class="stat-value" id="history-peak-power">-- W</span>
                        </div>
                    </div>

                    <div class="history-chart-container">
                        <canvas id="history-chart"></canvas>
                    </div>

                    <div id="no-history-data" class="empty-state hidden">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 17H7A5 5 0 017 7h2M15 7h2a5 5 0 010 10h-2M8 12h8"/>
                        </svg>
                        <p data-i18n="history.no_data">No data available for this period</p>
                    </div>
                </div>

                <!-- Session History Tab -->
                <div class="tab-content" id="session-history">
                    <div class="session-list" id="session-list">
                        <!-- Sessions will be dynamically rendered here -->
                    </div>
                    <div id="no-sessions" class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        <p data-i18n="history.no_sessions">No sessions recorded yet</p>
                    </div>
                </div>
            </section>

            <!-- Settings View -->
            <section id="settings" class="view">
                <header class="view-header">
                    <h1 data-i18n="nav.settings">Settings</h1>
                </header>

                <div class="settings-container">
                    <!-- General Settings -->
                    <div class="settings-section">
                        <h2 data-i18n="settings.general">General</h2>

                        <div class="setting-row">
                            <label data-i18n="settings.language">Language</label>
                            <select id="setting-language">
                                <option value="auto" data-i18n="settings.language.auto">Auto-detect</option>
                                <option value="en">English</option>
                                <option value="fr">Francais</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.theme">Theme</label>
                            <select id="setting-theme">
                                <option value="dark" data-i18n="settings.theme.dark">Dark</option>
                                <option value="light" data-i18n="settings.theme.light">Light</option>
                                <option value="system" data-i18n="settings.theme.system">System</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.refresh_rate_critical">Refresh Rate (Critical)</label>
                            <select id="setting-refresh-rate">
                                <option value="500">0.5s</option>
                                <option value="1000">1s</option>
                                <option value="2000">2s</option>
                                <option value="5000">5s</option>
                                <option value="10000">10s</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.refresh_rate_detailed">Refresh Rate (Detailed)</label>
                            <select id="setting-slow-refresh-rate">
                                <option value="3000">3s</option>
                                <option value="5000">5s</option>
                                <option value="10000">10s</option>
                                <option value="15000">15s</option>
                                <option value="30000">30s</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.eco_mode">Eco Mode</label>
                            <label class="toggle">
                                <input type="checkbox" id="setting-eco-mode">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.start_minimized">Start Minimized</label>
                            <label class="toggle">
                                <input type="checkbox" id="setting-start-minimized">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.start_with_system">Start with System</label>
                            <label class="toggle">
                                <input type="checkbox" id="setting-start-with-system">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Baseline Settings -->
                    <div class="settings-section">
                        <h2 data-i18n="settings.baseline">Baseline Detection</h2>

                        <div class="setting-row">
                            <label data-i18n="settings.baseline.auto">Auto-detect Baseline</label>
                            <label class="toggle">
                                <input type="checkbox" id="setting-baseline-auto" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-row" id="manual-baseline-row">
                            <label data-i18n="settings.baseline.manual">Manual Baseline (W)</label>
                            <input type="number" id="setting-baseline-watts" step="0.1" value="0" min="0">
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.baseline.detected">Detected Baseline</label>
                            <span class="info-text" id="detected-baseline">-- W</span>
                        </div>

                        <button class="btn btn-secondary" id="detect-baseline-btn" data-i18n="settings.baseline.detect_now">Detect Now</button>

                        <div class="setting-row" style="margin-top: var(--spacing-md);">
                            <label data-i18n="settings.process_limit">Process List Limit</label>
                            <input type="number" id="setting-process-limit" step="1" value="10" min="5" max="50">
                        </div>
                    </div>

                    <!-- Pricing Settings -->
                    <div class="settings-section">
                        <h2 data-i18n="settings.pricing">Pricing</h2>

                        <div class="setting-row">
                            <label data-i18n="settings.pricing.mode">Pricing Mode</label>
                            <select id="setting-pricing-mode">
                                <option value="simple" data-i18n="settings.pricing.mode.simple">Simple (flat rate)</option>
                                <option value="peak_offpeak" data-i18n="settings.pricing.mode.peak_offpeak">Peak/Off-peak</option>
                                <option value="seasonal" data-i18n="settings.pricing.mode.seasonal">Seasonal</option>
                                <option value="tempo" data-i18n="settings.pricing.mode.tempo">Tempo (EDF-style)</option>
                            </select>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.pricing.currency">Currency</label>
                            <select id="setting-currency">
                                <option value="EUR">EUR</option>
                                <option value="USD">$ USD</option>
                                <option value="GBP">GBP</option>
                                <option value="CHF">CHF</option>
                            </select>
                        </div>

                        <!-- Simple pricing -->
                        <div id="pricing-simple" class="pricing-mode-config">
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.rate">Rate per kWh</label>
                                <input type="number" id="setting-rate-kwh" step="0.0001" value="0.2276">
                            </div>
                        </div>

                        <!-- Peak/Off-peak pricing -->
                        <div id="pricing-peak-offpeak" class="pricing-mode-config hidden">
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.peak_rate">Peak Rate</label>
                                <input type="number" id="setting-peak-rate" step="0.0001" value="0.27">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.offpeak_rate">Off-peak Rate</label>
                                <input type="number" id="setting-offpeak-rate" step="0.0001" value="0.20">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.offpeak_start">Off-peak Start</label>
                                <input type="time" id="setting-offpeak-start" value="22:00">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.offpeak_end">Off-peak End</label>
                                <input type="time" id="setting-offpeak-end" value="06:00">
                            </div>
                        </div>

                        <!-- Seasonal pricing -->
                        <div id="pricing-seasonal" class="pricing-mode-config hidden">
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.summer_rate">Summer Rate</label>
                                <input type="number" id="setting-summer-rate" step="0.0001" value="0.20">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.winter_rate">Winter Rate</label>
                                <input type="number" id="setting-winter-rate" step="0.0001" value="0.25">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.winter_months">Winter Months</label>
                                <span class="info-text">Nov - Mar</span>
                            </div>
                        </div>

                        <!-- Tempo pricing (EDF-style) -->
                        <div id="pricing-tempo" class="pricing-mode-config hidden">
                            <h4 class="pricing-subsection" data-i18n="settings.pricing.tempo.blue">Blue Days</h4>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.tempo.peak">Peak</label>
                                <input type="number" id="setting-tempo-blue-peak" step="0.0001" value="0.16">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.tempo.offpeak">Off-peak</label>
                                <input type="number" id="setting-tempo-blue-offpeak" step="0.0001" value="0.13">
                            </div>

                            <h4 class="pricing-subsection" data-i18n="settings.pricing.tempo.white">White Days</h4>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.tempo.peak">Peak</label>
                                <input type="number" id="setting-tempo-white-peak" step="0.0001" value="0.19">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.tempo.offpeak">Off-peak</label>
                                <input type="number" id="setting-tempo-white-offpeak" step="0.0001" value="0.15">
                            </div>

                            <h4 class="pricing-subsection" data-i18n="settings.pricing.tempo.red">Red Days</h4>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.tempo.peak">Peak</label>
                                <input type="number" id="setting-tempo-red-peak" step="0.0001" value="0.76">
                            </div>
                            <div class="setting-row">
                                <label data-i18n="settings.pricing.tempo.offpeak">Off-peak</label>
                                <input type="number" id="setting-tempo-red-offpeak" step="0.0001" value="0.16">
                            </div>
                        </div>
                    </div>

                    <!-- Widget Settings -->
                    <div class="settings-section">
                        <h2 data-i18n="settings.widget">Widget</h2>

                        <div class="setting-row">
                            <label data-i18n="settings.widget.enabled">Enable Widget</label>
                            <button id="toggle-widget-btn" class="btn btn-secondary" data-i18n="settings.widget.open">Open Widget</button>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.widget.show_cost">Show Cost</label>
                            <label class="toggle">
                                <input type="checkbox" id="setting-widget-show-cost" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div class="setting-row">
                            <label data-i18n="settings.widget.position">Position</label>
                            <select id="setting-widget-position">
                                <option value="top_left" data-i18n="settings.widget.position.top_left">Top Left</option>
                                <option value="top_right" data-i18n="settings.widget.position.top_right">Top Right</option>
                                <option value="bottom_left" data-i18n="settings.widget.position.bottom_left">Bottom Left</option>
                                <option value="bottom_right" data-i18n="settings.widget.position.bottom_right">Bottom Right</option>
                            </select>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="settings-actions">
                        <button id="save-settings" class="btn btn-primary" data-i18n="action.save">Save</button>
                        <button id="reset-settings" class="btn btn-secondary" data-i18n="action.reset">Reset</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Process Search Modal -->
    <div class="modal hidden" id="process-search-modal">
        <div class="modal-content process-modal-content">
            <div class="modal-header">
                <h2 data-i18n="processes.all">All Processes</h2>
                <button class="btn btn-icon modal-close" id="close-process-modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="process-search-bar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="process-search-input" data-i18n-placeholder="processes.search_placeholder" placeholder="Search processes..." autocomplete="off">
                </div>
                <div class="process-loading-bar hidden" id="process-loading-bar">
                    <div class="process-loading-progress"></div>
                </div>
                <div class="process-modal-header">
                    <span class="process-modal-col-name" data-i18n="processes.header.name">Process</span>
                    <span class="process-modal-col-cpu" data-i18n="processes.header.cpu">CPU %</span>
                    <span class="process-modal-col-gpu" data-i18n="processes.header.gpu">GPU %</span>
                    <span class="process-modal-col-ram" data-i18n="processes.header.ram">RAM %</span>
                    <span class="process-modal-col-pin"></span>
                </div>
                <div class="process-modal-list" id="process-modal-list">
                    <!-- Processes will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Dashboard Modal -->
    <div class="modal hidden" id="edit-dashboard-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-i18n="dashboard.edit">Edit Dashboard</h2>
                <button class="btn btn-icon modal-close" id="close-edit-modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="modal-info" data-i18n="dashboard.edit_hint">Toggle widgets visibility and drag to reorder</p>
                <div class="widget-list" id="widget-toggle-list">
                    <!-- Widget toggles will be rendered here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="reset-dashboard-btn" data-i18n="dashboard.reset_default">Reset to Default</button>
                <button class="btn btn-primary" id="save-dashboard-btn" data-i18n="action.save">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <script type="module" src="src/main.js"></script>
</body>
</html>
